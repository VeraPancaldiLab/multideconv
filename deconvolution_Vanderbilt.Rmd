---
title: "deconvolution_Vanderbilt"
author: "Marcelo Hurtado"
date: "2025-04-22"
output: html_document
---

Set up environment
```{r setup, include=FALSE}
source("cell_deconvolution.R") #Load functions and packages
library(Seurat)
set.seed(123) #For reproducibility
```

Load input
```{r}
single.cell.data = SeuratDisk::LoadH5Seurat("~/Downloads/Vanderbilt_scRNA/all_samples.h5seurat",  assays = "RNA")
```

Create metacells
```{r}
metacells = create_metacells(single.cell.data, "annotated_ct_higher", "sample", exclude_cells = NULL, min_cells = 50, k = 25, max_shared = 15, n_workers = 4)
```

Create pseudobulk
```{r}
bulk_data = create_sc_pseudobulk(single.cell.data, "annotated_ct_higher", "sample", "Pseudobulk_sc")
```

Create list of DE genes for Bseq-sc
```{r}
metacells = Seurat::CreateSeuratObject(metacells$Counts, meta.data = metacells$Metadata)

cell_types <- unique(metacells@meta.data$annotated_ct_higher)

cell_type_hvg <- lapply(cell_types, function(ct) {
  cells <- Seurat::WhichCells(metacells, expression = annotated_ct_higher == ct)
  subset_obj <- subset(metacells, cells = cells)
  subset_obj <- Seurat::FindVariableFeatures(subset_obj, selection.method = "vst", nfeatures = 50)
  hvg <- Seurat::VariableFeatures(subset_obj)
  return(hvg)
})

names(cell_type_hvg) <- cell_types
```

Create signatures
```{r}
signatures = create_sc_signatures(metacells@assays$RNA@counts, metacells@meta.data, "annotated_ct_higher", "sample", credentials.mail = "marcelo.hurtado@inserm.fr", 
                                  credentials.token = "734212f6ad77fc4eea2bdb502792f294", bulk_rna = bulk_data, cell_markers = cell_type_hvg, 
                                  name_signature = "Vanderbilt", n_workers = 1)
```

Deconvolution all without signature creation
```{r}
deconv = compute.deconvolution(bulk_data, normalized = T, credentials.mail = "marcelo.hurtado@inserm.fr", credentials.token = "734212f6ad77fc4eea2bdb502792f294",
                               file_name = "Pseudobulk", create_signature = F,  sc_matrix = metacells@assays$RNA@counts, sc_metadata = metacells@meta.data, sc_deconv = T,
                               cell_label = "annotated_ct_higher", sample_label = "sample", name_sc_signature = "Vanderbilt", workers = 5)
```

Deconvolution only first-generation
```{r}
deconv = compute.deconvolution(bulk_data[,1:5], normalized = T, credentials.mail = "marcelo.hurtado@inserm.fr", credentials.token = "734212f6ad77fc4eea2bdb502792f294", file_name = "Tutorial")
```

Deconvolve only second-generation methods
```{r}
deconv = compute_sc_deconvolution_methods(bulk_data[,1:5], normalized = T, metacells$Counts, metacells$Metadata, "annotated_ct_higher", 
                                          "sample", "Test", n_cores = 4, return = T, file_name = "Vanderbilt")
```

Deconvolution first generation + create signatures 
```{r}
deconv = compute.deconvolution(bulk_data[,1:5], normalized = T, credentials.mail = "marcelo.hurtado@inserm.fr", credentials.token = "734212f6ad77fc4eea2bdb502792f294",
                               file_name = "Tutorial", create_signature = T,  sc_matrix = metacells$Counts, sc_metadata = metacells$Metadata, 
                               cell_label = "annotated_ct_higher", sample_label = "sample", cell_markers = cell_type_hvg, name_sc_signature = "Vanderbilt", workers = 1)
```

Deconvolution all + create signatures (No recommended) 
```{r}
deconv = compute.deconvolution(bulk_data[,1:5], normalized = T, credentials.mail = "marcelo.hurtado@inserm.fr", credentials.token = "734212f6ad77fc4eea2bdb502792f294",
                               file_name = "Tutorial", create_signature = T,  sc_matrix = metacells$Counts, sc_metadata = metacells$Metadata, sc_deconv = T,
                               cell_label = "annotated_ct_higher", sample_label = "sample", cell_markers = cell_type_hvg, name_sc_signature = "Vanderbilt", workers = 1)
```

Benchmarking deconvolution

Groundtruth
```{r}
tab <- table(metacells$Metadata$sample, metacells$Metadata$annotated_ct_higher)
cells_groundtruth <- as.data.frame.matrix(prop.table(tab, margin = 1))

cells_groundtruth <- cells_groundtruth %>%
  dplyr::rename("B.cells" = "B cells",
                "Cancer" = "Cancer cells",
                "Endothelial" = "Endothelial cells", 
                "Mural.cells" = "Mural cells",
                "Myeloid.cells" = "Myeloid cells",
                "T.cells" = "T cells")
```

Benchmark 
```{r}
corr_matrix = benchmarking_deconvolution(deconv_raw, cells_groundtruth, cells_extra = c("Mural.cells", "Myeloid.cells", "T.cells"),
                                         corr_type = "pearson", scatter = F, pval = 0.05, file_name = "Test", height = 12, width = 8)
```

